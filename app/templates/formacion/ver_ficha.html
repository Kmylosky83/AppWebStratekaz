{% extends "base.html" %}

{% block title %}Ficha de Formación - {{ ficha.titulo }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                    <h3 class="mb-0">{{ ficha.titulo }}</h3>
                    <span class="badge bg-secondary">{{ ficha.codigo }}</span>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Fecha:</strong> {{ ficha.fecha.strftime('%d/%m/%Y %H:%M') }}</p>
                            <p class="mb-1"><strong>Lugar:</strong> {{ ficha.lugar or 'No especificado' }}</p>
                            <p class="mb-1"><strong>Duración:</strong> {{ ficha.duracion or 'No especificada' }}</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Responsable:</strong> {{ ficha.responsable }}</p>
                            {% if ficha.empresa_id %}
                            <p class="mb-1"><strong>Empresa:</strong> {{ ficha.empresa.nombre }}</p>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h5>Descripción</h5>
                        <p>{{ ficha.descripcion or 'Sin descripción' }}</p>
                    </div>
                    
                    <div class="mb-4">
                        <h5>Objetivos</h5>
                        {% if ficha.objetivos %}
                        <ol class="px-3">
                            {% for objetivo in ficha.objetivos.split('\n') %}
                                {% if objetivo.strip() %}
                                <li>{{ objetivo.replace('•', '').strip() }}</li>
                                {% endif %}
                            {% endfor %}
                        </ol>
                        {% else %}
                        <p>Sin objetivos definidos</p>
                        {% endif %}
                    </div>
                    
                    {% if ficha.preguntas %}
                    <div class="mb-4">
                        <h5>Preguntas para Asistentes</h5>
                        <div class="list-group">
                            {% for pregunta in ficha.preguntas %}
                            <div class="list-group-item">
                                <h6 class="mb-1">{{ pregunta.texto }}</h6>
                                <p class="mb-0 text-muted small">
                                    Tipo: 
                                    {% if pregunta.tipo == 'texto' %}
                                        Texto libre
                                    {% elif pregunta.tipo == 'si_no' %}
                                        Sí/No
                                    {% elif pregunta.tipo == 'opcion_multiple' %}
                                        Opción múltiple
                                    {% endif %}
                                </p>
                                
                                {% if pregunta.tipo == 'opcion_multiple' %}
                                <div class="mt-2">
                                    <strong>Opciones:</strong>
                                    <ul class="mb-0">
                                        {% for opcion in pregunta.opciones|from_json %}
                                        <li>{{ opcion }}</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}
                    <div class="mt-4 text-end">
                        <button type="button" class="btn btn-outline-danger" data-bs-toggle="modal" data-bs-target="#eliminarFichaModal">
                            <i class="fas fa-trash me-2"></i>Eliminar Ficha
                        </button>
                    </div>
                </div>
                <div class="card-footer bg-white d-flex justify-content-between">
                    <a href="{{ url_for('formacion.index') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Volver
                    </a>
                    <div>
                        <a href="{{ url_for('formacion.editar_ficha', ficha_id=ficha.id) }}" class="btn btn-outline-primary me-2">
                            <i class="fas fa-edit me-2"></i>Editar
                        </a>
                        {% if lista and lista.asistentes %}
                        <a href="{{ url_for('formacion.generar_acta', ficha_id=ficha.id) }}" class="btn btn-primary">
                            <i class="fas fa-file-pdf me-2"></i>Generar Acta
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0">Lista de Asistencia</h5>
                </div>
                <div class="card-body">
                    {% if lista %}
                        <div class="d-grid gap-3 mb-4">
                            <button class="btn btn-primary" data-clipboard-text="{{ url_for('formacion.lista_asistencia', enlace=lista.enlace_compartible, _external=True) }}" id="copiar-enlace">
                                <i class="fas fa-link me-2"></i>Copiar Enlace
                            </button>
                            <a href="{{ url_for('formacion.lista_asistencia', enlace=lista.enlace_compartible) }}" target="_blank" class="btn btn-outline-primary">
                                <i class="fas fa-external-link-alt me-2"></i>Abrir Formulario
                            </a>
                        </div>
                        
                        <h6>Asistentes Registrados</h6>
                        
                        {% if lista.asistentes %}
                            <div class="list-group mt-3">
                                {% for asistente in lista.asistentes %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">{{ asistente.nombre }}</h6>
                                        <p class="mb-0 text-muted small">{{ asistente.email }}</p>
                                    </div>
                                    <span class="badge bg-primary rounded-pill">
                                        {{ asistente.fecha_registro.strftime('%d/%m/%Y') }}
                                    </span>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <img src="{{ url_for('static', filename='images/empty-data.svg') }}" alt="Sin asistentes" class="img-fluid mb-3" style="max-height: 100px;">
                                <p class="text-muted mb-0">Aún no hay asistentes registrados</p>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted">No se ha creado una lista de asistencia para esta ficha</p>
                            <button class="btn btn-primary mt-2">Crear Lista de Asistencia</button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sección de Acta del Evento -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0">Acta del Evento</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <p class="mb-0">Gestione las imágenes que se mostrarán en el acta del evento.</p>
                        <div>
                            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#imagenModal">
                                <i class="fas fa-image me-1"></i>Gestionar Imágenes
                            </button>
                            {% if lista and lista.asistentes %}
                            <a href="{{ url_for('formacion.generar_acta', ficha_id=ficha.id) }}" class="btn btn-primary ms-2">
                                <i class="fas fa-file-alt me-1"></i>Ver Acta
                            </a>
                            {% else %}
                            <button class="btn btn-primary ms-2" disabled>
                                <i class="fas fa-file-alt me-1"></i>Ver Acta
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Mostrar miniaturas de imágenes si existen -->
                    {% if ficha.logo_personalizado or ficha.imagen_evento1 or ficha.imagen_evento2 %}
                    <div class="row mt-4">
                        {% if ficha.logo_personalizado %}
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header bg-light py-2">
                                    <small>Logo personalizado</small>
                                </div>
                                <div class="card-body text-center">
                                    <img src="{{ url_for('static', filename='uploads/' + ficha.logo_personalizado) }}" 
                                         alt="Logo" class="img-thumbnail" style="max-height: 100px;">
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if ficha.imagen_evento1 %}
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header bg-light py-2">
                                    <small>Imagen del evento 1</small>
                                </div>
                                <div class="card-body text-center">
                                    <img src="{{ url_for('static', filename='uploads/' + ficha.imagen_evento1) }}" 
                                         alt="Imagen 1" class="img-thumbnail" style="max-height: 100px;">
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if ficha.imagen_evento2 %}
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header bg-light py-2">
                                    <small>Imagen del evento 2</small>
                                </div>
                                <div class="card-body text-center">
                                    <img src="{{ url_for('static', filename='uploads/' + ficha.imagen_evento2) }}" 
                                         alt="Imagen 2" class="img-thumbnail" style="max-height: 100px;">
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <p class="text-muted small mt-3">No hay imágenes configuradas para el acta.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Eliminación -->
<div class="modal fade" id="eliminarFichaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('formacion.eliminar_ficha', ficha_id=ficha.id) }}" method="POST">
                <div class="modal-body">
                    <p class="text-danger">¡Atención! Esta acción eliminará permanentemente la ficha y todos sus datos asociados.</p>
                    <div class="mb-3">
                        <label for="password" class="form-label">Ingrese su contraseña para confirmar:</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-danger">Eliminar Ficha</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para imágenes -->
<div class="modal fade" id="imagenModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gestionar Imágenes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{{ url_for('formacion.subir_imagenes', ficha_id=ficha.id) }}" method="POST" enctype="multipart/form-data">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Logo Personalizado</label>
                        <input type="file" class="form-control" name="logo" accept="image/*">
                        <div class="form-text">Reemplazará el logo predeterminado en el acta.</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Imagen del Evento 1</label>
                        <input type="file" class="form-control" name="imagen1" accept="image/*">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Imagen del Evento 2</label>
                        <input type="file" class="form-control" name="imagen2" accept="image/*">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Imágenes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.8/clipboard.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar clipboard.js
    const clipboard = new ClipboardJS('#copiar-enlace');
    
    clipboard.on('success', function(e) {
        const button = e.trigger;
        const originalText = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-check me-2"></i>¡Enlace Copiado!';
        button.classList.remove('btn-primary');
        button.classList.add('btn-success');
        
        setTimeout(function() {
            button.innerHTML = originalText;
            button.classList.remove('btn-success');
            button.classList.add('btn-primary');
        }, 2000);
        
        e.clearSelection();
    });
});
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var clipboard = new ClipboardJS('#copiar-enlace');
        
        clipboard.on('success', function(e) {
            alert('Enlace copiado al portapapeles');
            e.clearSelection();
        });
    });
    </script>
{% endblock %}